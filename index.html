<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聚合云盘搜索 - PikPak 增强版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-[#050301]">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const Icons = {
            Search: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Cloud: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.5 19c0-1.7-1.3-3-3-3h-1.1c-.1-2.9-2.5-5.3-5.4-5.3-2.6 0-4.8 1.9-5.3 4.4C1.2 16.2 2.1 19 5 19h12.5c1.4 0 2.5-1.1 2.5-2.5v-.5"/></svg>,
            Disc: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>,
            Zap: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            Rocket: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.71.79-1.35.79-1.35l-1.44-1.44S6.21 16.71 4.5 16.5z"/><path d="M7 11l4 4L22 3l-8 8-4-4-3 7z"/></svg>,
            Loader2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            X: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        };

        const PROVIDERS = {
            aliyun: { id: 'aliyun', name: '阿里', match: (url) => /alipan|aliyundrive/.test(url), icon: <Icons.Cloud size={14}/>, style: 'bg-orange-500/10 text-orange-400 border-orange-500/20' },
            pikpak: { id: 'pikpak', name: 'PikPak', match: (url) => /pikpak|magnet|btih:/.test(url), icon: <Icons.Rocket size={14}/>, style: 'bg-blue-500/10 text-blue-400 border-blue-500/20' },
            quark: { id: 'quark', name: '夸克', match: (url) => /quark/.test(url), icon: <Icons.Disc size={14}/>, style: 'bg-white/5 text-slate-400 border-white/10' },
            other: { id: 'other', name: '其他', match: () => true, icon: <Icons.Zap size={14}/>, style: 'bg-white/5 text-slate-500 border-white/10' }
        };

        const App = () => {
            const [keyword, setKeyword] = useState('');
            const [allItems, setAllItems] = useState([]);
            const [loading, setLoading] = useState(false);
            const [apiUrl] = useState("sodx.zeabur.app");

            const handleSearch = async (e) => {
                if (e) e.preventDefault();
                setLoading(true);
                try {
                    const res = await fetch(`https://${apiUrl}/api/search?kw=${encodeURIComponent(keyword)}&res=merge`);
                    const data = await res.json();
                    let list = data.data || data.list || [];
                    if (data?.data?.merged_by_type) list = Object.values(data.data.merged_by_type).flat();
                    
                    const processed = list.map(item => {
                        const url = item.url || "";
                        let provider = 'other';
                        if (/magnet|btih:/.test(url)) provider = 'pikpak';
                        else if (/alipan|aliyundrive/.test(url)) provider = 'aliyun';
                        else if (/quark/.test(url)) provider = 'quark';
                        return { name: item.note || item.name || "未知", url, provider };
                    });
                    setAllItems(processed);
                } catch (e) { alert("搜索失败"); }
                setLoading(false);
            };

            const pushToPikPak = (url) => {
                // 唤起 PikPak APP 的特殊协议
                const schemeUrl = `pikpak://add?url=${encodeURIComponent(url)}`;
                window.location.href = schemeUrl;
                // 兜底方案：如果没安装，3秒后尝试打开网页版
                setTimeout(() => {
                    if (confirm("是否跳转到 PikPak 网页版投喂？")) {
                        window.open(`https://mypikpak.com/drive/url-checker?url=${encodeURIComponent(url)}`, '_blank');
                    }
                }, 2000);
            };

            return (
                <div className="min-h-screen p-4 pt-20 max-w-2xl mx-auto">
                    <form onSubmit={handleSearch} className="flex gap-2 mb-10">
                        <input type="text" value={keyword} onChange={e=>setKeyword(e.target.value)} placeholder="输入片名，一键推送到PikPak..." className="flex-1 bg-white/5 border border-white/10 rounded-2xl px-4 py-3 outline-none focus:border-blue-500 text-white"/>
                        <button className="bg-blue-600 px-6 rounded-2xl font-bold text-white">{loading ? <Icons.Loader2 className="animate-spin"/> : "搜索"}</button>
                    </form>

                    <div className="space-y-3">
                        {allItems.map((item, i) => (
                            <div key={i} className="bg-white/5 border border-white/10 p-4 rounded-2xl flex flex-col gap-3">
                                <div className="flex items-center gap-2">
                                    <span className={`px-2 py-0.5 rounded text-[10px] ${PROVIDERS[item.provider].style}`}>{PROVIDERS[item.provider].name}</span>
                                    <h3 className="text-slate-200 text-sm font-bold truncate flex-1">{item.name}</h3>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={()=>navigator.clipboard.writeText(item.url)} className="flex-1 py-2 bg-white/5 rounded-xl text-xs text-slate-400">复制链接</button>
                                    <button onClick={()=>pushToPikPak(item.url)} className="flex-1 py-2 bg-blue-600/20 border border-blue-500/30 rounded-xl text-xs text-blue-400 font-bold flex items-center justify-center gap-1">
                                        <Icons.Rocket size={12}/> 秒传 PikPak
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>